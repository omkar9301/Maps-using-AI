<!DOCTYPE html>
<html>
<head>
  <title>User Road Safety Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    #map { height: 90vh; width: 100%; }
    #routeForm { margin: 10px; }
    input, button { padding: 6px; margin: 4px; }
    .autocomplete-suggestions {
      border: 1px solid #ccc;
      max-height: 150px;
      overflow-y: auto;
      position: absolute;
      background: white;
      z-index: 1000;
    }
    .autocomplete-suggestions div {
      padding: 6px;
      cursor: pointer;
    }
    .autocomplete-suggestions div:hover {
      background-color: #e0e0e0;
    }
  </style>
</head>
<body>
  <h3>Route with Hazards & Your Location</h3>

  <form id="routeForm" autocomplete="off">
    <div style="position:relative;">
      <input type="text" id="start" placeholder="Start (e.g. Mumbai)" required />
      <div id="start-suggestions" class="autocomplete-suggestions"></div>
    </div>
    <div style="position:relative;">
      <input type="text" id="end" placeholder="Destination (e.g. Pune)" required />
      <div id="end-suggestions" class="autocomplete-suggestions"></div>
    </div>
    <button type="submit">Get Route</button>
    <button type="button" id="startJourney">Start Journey</button>
  </form>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    let map;
    let userLat = 19.0760, userLng = 72.8777;
    let routeLayer;
    let hazardMarkers = [];
    let journeyStarted = false;

    const apiKey = "5b3ce3597851110001cf6248d8549b2641fe4b03a6b7c5b9cfed6757";

    function initMap() {
      map = L.map('map').setView([userLat, userLng], 13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

      const userMarker = L.marker([userLat, userLng], { title: "You are here" }).addTo(map);
      userMarker.bindPopup("<b>You are here</b>").openPopup();

      fetch('/api/hazards')
        .then(res => res.json())
        .then(hazards => {
          hazards.forEach(h => {
            const marker = L.marker([h.lat, h.lng]).addTo(map);
            marker.bindPopup(`<b>${h.type.toUpperCase()}</b><br>Severity: ${h.severity}`);
            hazardMarkers.push({ lat: h.lat, lng: h.lng, type: h.type });
          });
        });
    }

    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(pos => {
        userLat = pos.coords.latitude;
        userLng = pos.coords.longitude;
        initMap();
      }, error => {
        console.warn("Geolocation error:", error.message);
        initMap();
      }, {
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 0
      });
    } else {
      alert("Geolocation not supported by this browser.");
      initMap();
    }

    document.getElementById('routeForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const start = document.getElementById('start').value;
      const end = document.getElementById('end').value;

      Promise.all([geocode(start), geocode(end)]).then(([startCoord, endCoord]) => {
        if (!startCoord || !endCoord) {
          alert("Could not find one or both locations.");
          return;
        }
        getRoute(startCoord, endCoord);
      });
    });

    document.getElementById('startJourney').addEventListener('click', () => {
      journeyStarted = true;
      alert("Journey started! You will be alerted when near hazards.");
      trackPosition();
    });

    function geocode(place) {
      return fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(place)}`)
        .then(res => res.json())
        .then(data => {
          if (data.length > 0) {
            const lat = parseFloat(data[0].lat);
            const lon = parseFloat(data[0].lon);
            return [lon, lat];
          }
          return null;
        });
    }

    function getRoute(startCoord, endCoord) {
      const url = 'https://api.openrouteservice.org/v2/directions/driving-car/geojson';

      fetch(url, {
        method: 'POST',
        headers: {
          'Authorization': apiKey,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          coordinates: [startCoord, endCoord]
        })
      })
      .then(response => {
        if (!response.ok) throw new Error("Route fetch failed.");
        return response.json();
      })
      .then(data => {
        if (!data.features || !data.features[0]) {
          alert("No route found.");
          return;
        }

        const coords = data.features[0].geometry.coordinates.map(c => [c[1], c[0]]);
        if (routeLayer) map.removeLayer(routeLayer);
        routeLayer = L.polyline(coords, { color: 'blue', weight: 5 }).addTo(map);
        map.fitBounds(routeLayer.getBounds());
      })
      .catch(err => {
        console.error("Routing error:", err);
        alert("Failed to fetch route. Check console for details.");
      });
    }

    function setupAutocomplete(inputId, suggestionId) {
      const input = document.getElementById(inputId);
      const suggestionBox = document.getElementById(suggestionId);

      input.addEventListener('input', () => {
        const query = input.value;
        if (query.length < 3) {
          suggestionBox.innerHTML = '';
          return;
        }

        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`)
          .then(res => res.json())
          .then(data => {
            suggestionBox.innerHTML = '';
            const currentLoc = document.createElement('div');
            currentLoc.textContent = 'Use Current Location';
            currentLoc.addEventListener('click', () => {
              input.value = `${userLat}, ${userLng}`;
              suggestionBox.innerHTML = '';
            });
            suggestionBox.appendChild(currentLoc);

            data.slice(0, 5).forEach(place => {
              const div = document.createElement('div');
              div.textContent = place.display_name;
              div.addEventListener('click', () => {
                input.value = place.display_name;
                suggestionBox.innerHTML = '';
              });
              suggestionBox.appendChild(div);
            });
          });
      });

      document.addEventListener('click', (e) => {
        if (!suggestionBox.contains(e.target) && e.target !== input) {
          suggestionBox.innerHTML = '';
        }
      });
    }

    function trackPosition() {
      if (navigator.geolocation && journeyStarted) {
        navigator.geolocation.watchPosition(pos => {
          const currentLat = pos.coords.latitude;
          const currentLng = pos.coords.longitude;

          hazardMarkers.forEach(h => {
            const distance = getDistance(currentLat, currentLng, h.lat, h.lng);
            if (distance <= 50) {
              alert(`Caution! ${h.type.toUpperCase()} ahead within ${distance.toFixed(1)} meters.`);
            }
          });
        }, err => console.warn(err), {
          enableHighAccuracy: true,
          maximumAge: 0,
          timeout: 5000
        });
      }
    }

    function getDistance(lat1, lon1, lat2, lon2) {
      const R = 6371e3;
      const φ1 = lat1 * Math.PI / 180;
      const φ2 = lat2 * Math.PI / 180;
      const Δφ = (lat2 - lat1) * Math.PI / 180;
      const Δλ = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                Math.cos(φ1) * Math.cos(φ2) *
                Math.sin(Δλ/2) * Math.sin(Δλ/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c; // in meters
    }

    setupAutocomplete('start', 'start-suggestions');
    setupAutocomplete('end', 'end-suggestions');
  </script>
</body>
</html>