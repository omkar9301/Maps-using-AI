<!DOCTYPE html>
<html>
<head>
  <title>User Road Safety Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">

  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: 'Roboto', sans-serif;
      overflow: hidden;
    }
  
    #map {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: 100%;
      z-index: 0;
    }
  
    #routeForm {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      border-radius: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      padding: 10px 20px;
      display: flex;
      gap: 10px;
      align-items: center;
      z-index: 1000;
      max-width: 700px;
      width: 90%;
    }
  
    #routeForm input {
      flex: 1;
      border: none;
      font-size: 16px;
      padding: 8px;
      border-radius: 20px;
      background: #f1f3f4;
    }
  
    #routeForm button {
      background: #4285F4;
      color: white;
      border: none;
      font-size: 16px;
      padding: 8px 16px;
      border-radius: 20px;
      cursor: pointer;
      transition: background 0.3s;
    }
  
    #routeForm button:hover {
      background: #3367d6;
    }
  
    .autocomplete-suggestions {
      position: absolute;
      top: 60px;
      width: calc(100% - 40px);
      margin: 0 20px;
      background: white;
      border: 1px solid #ccc;
      border-radius: 8px;
      max-height: 150px;
      overflow-y: auto;
      z-index: 1000;
    }
  
    .autocomplete-suggestions div {
      padding: 10px;
      cursor: pointer;
    }
  
    .autocomplete-suggestions div:hover {
      background-color: #f1f1f1;
    }
  </style>
  
  
</head>
<body>
  <nav>
    Smart Road Safety
  </nav>
  
  <h3>Route with Hazards & Your Location</h3>

  <form id="routeForm" autocomplete="off">
    <div style="position:relative;">
      <input type="text" id="start" placeholder="Start (e.g. Mumbai)" required />
      <div id="start-suggestions" class="autocomplete-suggestions"></div>
    </div>
    <div style="position:relative;">
      <input type="text" id="end" placeholder="Destination (e.g. Pune)" required />
      <div id="end-suggestions" class="autocomplete-suggestions"></div>
    </div>
    <button type="submit">Get Route</button>
    <button type="button" id="startJourney">Start Journey</button>
  </form>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    let map;
    let userLat = 19.0760, userLng = 72.8777;
    let routeLayer;
    let hazardMarkers = [];
    let journeyStarted = false;
    let liveMarker;

    const apiKey = "5b3ce3597851110001cf6248d8549b2641fe4b03a6b7c5b9cfed6757";

    function initMap() {
      map = L.map('map').setView([userLat, userLng], 13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

      const userMarker = L.marker([userLat, userLng], { title: "You are here" }).addTo(map);
      userMarker.bindPopup("<b>You are here</b>").openPopup();

      fetch('/api/hazards')
        .then(res => res.json())
        .then(hazards => {
          hazards.forEach(h => {
            const marker = L.marker([h.lat, h.lng]).addTo(map);
            marker.bindPopup(`<b>${h.type.toUpperCase()}</b><br>Severity: ${h.severity}`);
            hazardMarkers.push({ lat: h.lat, lng: h.lng, type: h.type });
          });
        });
    }

    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(pos => {
        userLat = pos.coords.latitude;
        userLng = pos.coords.longitude;
        initMap();
      }, error => {
        console.warn("Geolocation error:", error.message);
        initMap();
      }, {
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 0
      });
    } else {
      alert("Geolocation not supported by this browser.");
      initMap();
    }

    document.getElementById('routeForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const start = document.getElementById('start').value;
      const end = document.getElementById('end').value;

      Promise.all([geocode(start), geocode(end)]).then(([startCoord, endCoord]) => {
        if (!startCoord || !endCoord) {
          alert("Could not find one or both locations.");
          return;
        }
        getRoute(startCoord, endCoord);
      });
    });

    document.getElementById('startJourney').addEventListener('click', () => {
      journeyStarted = true;
      alert("Journey started! You will be alerted when near hazards.");
      trackPosition();
    });

    function geocode(place) {
      return fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(place)}`)
        .then(res => res.json())
        .then(data => {
          if (data.length > 0) {
            const lat = parseFloat(data[0].lat);
            const lon = parseFloat(data[0].lon);
            return [lon, lat];
          }
          return null;
        });
    }

    function getRoute(startCoord, endCoord) {
  const url = 'https://api.openrouteservice.org/v2/directions/driving-car/geojson';

  fetch(url, {
    method: 'POST',
    headers: {
      'Authorization': apiKey,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      coordinates: [startCoord, endCoord]
    })
  })
  .then(response => {
    if (!response.ok) throw new Error("Route fetch failed.");
    return response.json();
  })
  .then(data => {
    if (!data.features || !data.features[0]) {
      alert("No route found.");
      return;
    }

    const coords = data.features[0].geometry.coordinates.map(c => [c[1], c[0]]);
    if (routeLayer) map.removeLayer(routeLayer);
    routeLayer = L.polyline(coords, { color: 'blue', weight: 5 }).addTo(map);
    map.fitBounds(routeLayer.getBounds());

    // Add Start and End markers
    const startIcon = L.icon({
      iconUrl: 'https://maps.google.com/mapfiles/ms/icons/green-dot.png',
      iconSize: [32, 32],
      iconAnchor: [16, 32],
    });

    const endIcon = L.icon({
      iconUrl: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png',
      iconSize: [32, 32],
      iconAnchor: [16, 32],
    });

    L.marker([startCoord[1], startCoord[0]], { icon: startIcon }).addTo(map).bindPopup("Start Point").openPopup();
    L.marker([endCoord[1], endCoord[0]], { icon: endIcon }).addTo(map).bindPopup("End Point");

  })
  .catch(err => {
    console.error("Routing error:", err);
    alert("Failed to fetch route. Check console for details.");
  });
}


    function setupAutocomplete(inputId, suggestionId) {
      const input = document.getElementById(inputId);
      const suggestionBox = document.getElementById(suggestionId);

      input.addEventListener('input', () => {
        const query = input.value;
        if (query.length < 3) {
          suggestionBox.innerHTML = '';
          return;
        }

        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`)
          .then(res => res.json())
          .then(data => {
            suggestionBox.innerHTML = '';
            const currentLoc = document.createElement('div');
            currentLoc.textContent = 'Use Current Location';
            currentLoc.addEventListener('click', () => {
              input.value = `${userLat}, ${userLng}`;
              suggestionBox.innerHTML = '';
            });
            suggestionBox.appendChild(currentLoc);

            data.slice(0, 5).forEach(place => {
              const div = document.createElement('div');
              div.textContent = place.display_name;
              div.addEventListener('click', () => {
                input.value = place.display_name;
                suggestionBox.innerHTML = '';
              });
              suggestionBox.appendChild(div);
            });
          });
      });

      document.addEventListener('click', (e) => {
        if (!suggestionBox.contains(e.target) && e.target !== input) {
          suggestionBox.innerHTML = '';
        }
      });
    }

    function trackPosition() {
      if (navigator.geolocation && journeyStarted) {
        navigator.geolocation.watchPosition(pos => {
          const currentLat = pos.coords.latitude;
          const currentLng = pos.coords.longitude;

          if (!liveMarker) {
            liveMarker = L.marker([currentLat, currentLng], { title: "Live Location" }).addTo(map);
          } else {
            liveMarker.setLatLng([currentLat, currentLng]);
          }

          map.setView([currentLat, currentLng]);

          hazardMarkers.forEach(h => {
            const distance = getDistance(currentLat, currentLng, h.lat, h.lng);
            if (distance <= 50) {
              alert(`Caution! ${h.type.toUpperCase()} ahead within ${distance.toFixed(1)} meters.`);
            }
          });
        }, err => console.warn(err), {
          enableHighAccuracy: true,
          maximumAge: 0,
          timeout: 5000
        });
      }
    }

    function getDistance(lat1, lon1, lat2, lon2) {
      const R = 6371e3;
      const φ1 = lat1 * Math.PI / 180;
      const φ2 = lat2 * Math.PI / 180;
      const Δφ = (lat2 - lat1) * Math.PI / 180;
      const Δλ = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                Math.cos(φ1) * Math.cos(φ2) *
                Math.sin(Δλ/2) * Math.sin(Δλ/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    setupAutocomplete('start', 'start-suggestions');
    setupAutocomplete('end', 'end-suggestions');
  </script>
</body>
</html>
